<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANKET - SPM Analysis Tool</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="RTIS.js"></script>
    <script src="googlesheet.js"></script> 

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #2c3e50; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section-title { grid-column: span 2; font-weight: bold; color: #3498db; border-bottom: 1px solid #eee; margin-top: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; font-size: 13px; color: #555; margin-bottom: 4px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        input[readonly] { background: #f9f9f9; color: #777; }
        .btn-analyze { grid-column: span 2; padding: 15px; background: #27ae60; color: white; border: none; font-size: 18px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        .btn-analyze:hover { background: #219150; }
        #dbStatus { text-align: center; font-size: 12px; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>SANKET</h1>
        <p>SPM Analysis & Navigation KPA Extraction Tool</p>
    </div>
    
    <div id="dbStatus">Loading Database...</div>

    <div class="form-grid">
        <div class="section-title">Trip Details</div>
        <div class="form-group"><label>Train No</label><input type="text" id="trainNo" onblur="checkDuplicateEntry()"></div>
        <div class="form-group"><label>Journey Date</label><input type="date" id="journeyDate" onblur="checkDuplicateEntry()"></div>
        <div class="form-group"><label>Loco No</label><input type="text" id="locoNo"></div>
        <div class="form-group"><label>Load Condition</label>
            <select id="trainLoad"><option value="LOAD">LOADED</option><option value="EMPTY">EMPTY</option></select>
        </div>

        <div class="section-title">Analysis CLI</div>
        <div class="form-group"><label>CLI ID</label><input type="text" id="cliId" placeholder="e.g. BSP0187" onblur="autoFillCLI()"></div>
        <div class="form-group"><label>CLI Name</label><input type="text" id="cliName" readonly></div>

        <div class="section-title">LP Details</div>
        <div class="form-group"><label>LP ID</label><input type="text" id="lpId" onblur="autoFillLP()"></div>
        <div class="form-group"><label>LP Name</label><input type="text" id="lpName" readonly></div>
        <input type="hidden" id="lpDesg"><input type="hidden" id="lpGroupCli"><input type="hidden" id="lpCug">

        <div class="section-title">ALP Details</div>
        <div class="form-group"><label>ALP ID</label><input type="text" id="alpId" onblur="autoFillALP()"></div>
        <div class="form-group"><label>ALP Name</label><input type="text" id="alpName" readonly></div>
        <input type="hidden" id="alpDesg"><input type="hidden" id="alpGroupCli"><input type="hidden" id="alpCug">

        <div class="section-title">Technical Parameters</div>
        <div class="form-group"><label>From Stn</label><input type="text" id="fromStn"></div>
        <div class="form-group"><label>To Stn</label><input type="text" id="toStn"></div>
        <div class="form-group"><label>Rake Type</label>
            <select id="rakeType"><option value="GOODS">GOODS</option><option value="COACHING">COACHING</option><option value="MEMU">MEMU</option></select>
        </div>
        <div class="form-group"><label>MPS</label><input type="number" id="mps" value="110"></div>
        <div class="form-group" style="grid-column: span 2;"><label>Section</label><input type="text" id="section" value="NGP-BSP"></div>

        <div class="section-title">Upload Data</div>
        <div class="form-group" style="grid-column: span 2;">
            <label>SPM/RTIS File (.csv)</label>
            <input type="file" id="spmFile" accept=".csv">
        </div>

        <button class="btn-analyze" id="analyzeBtn" onclick="startAnalysis()">Analyze Data</button>
    </div>
</div>

<script>
    // 1. CONFIG: FILE PATHS (Local Folder)
    const MASTER_FILES = {
        CREW: "./CREW.csv",
        CLI: "./CLIMICRO.csv",
        STATION: "./Station_Signal_Interdistant.csv"
    };

    let crewData = [], cliData = [];
    window.stationData = [];

    // 2. LOAD DATABASE
    window.onload = async function() {
        try {
            await Promise.all([
                loadCSV(MASTER_FILES.CREW, d => crewData = d),
                loadCSV(MASTER_FILES.CLI, d => cliData = d),
                loadCSV(MASTER_FILES.STATION, d => window.stationData = d)
            ]);
            document.getElementById('dbStatus').innerHTML = "✅ Database Connected";
            document.getElementById('dbStatus').style.color = "green";
        } catch (e) {
            document.getElementById('dbStatus').innerHTML = "❌ Database Load Failed (Check File Names)";
            document.getElementById('dbStatus').style.color = "red";
        }
    };

    async function loadCSV(url, cb) {
        return new Promise((resolve) => {
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => { cb(res.data); resolve(); },
                error: () => resolve() // Continue even if fail
            });
        });
    }

    // 3. AUTO FILL FUNCTIONS
    window.autoFillCLI = function() {
        const id = document.getElementById('cliId').value.trim().toUpperCase();
        const match = cliData.find(r => r['LI ID'] == id);
        if(match) document.getElementById('cliName').value = match['NAME'];
        else { alert('CLI ID Not Found'); document.getElementById('cliName').value = ''; }
    };

    window.autoFillLP = function() { fillCrew('lp'); };
    window.autoFillALP = function() { fillCrew('alp'); };

    function fillCrew(type) {
        const id = document.getElementById(type+'Id').value.trim().toUpperCase();
        const match = crewData.find(r => r['CREWID'] == id);
        if(match) {
            document.getElementById(type+'Name').value = match['CREW NAME'];
            document.getElementById(type+'Desg').value = match['DESG'] || '';
            document.getElementById(type+'GroupCli').value = match['CLI NAME'] || '';
            document.getElementById(type+'Cug').value = match['CUG NUMBER'] || '';
        } else {
            alert(type.toUpperCase() + ' ID Not Found');
        }
    }

    // 4. START ANALYSIS
    window.startAnalysis = async function() {
        const file = document.getElementById('spmFile').files[0];
        if(!file) { alert("Please upload file"); return; }

        const inputs = {
            trainNo: document.getElementById('trainNo').value,
            journeyDate: document.getElementById('journeyDate').value,
            locoNo: document.getElementById('locoNo').value,
            trainLoad: document.getElementById('trainLoad').value,
            cliName: document.getElementById('cliName').value,
            
            lpId: document.getElementById('lpId').value,
            lpName: document.getElementById('lpName').value,
            lpDesg: document.getElementById('lpDesg').value,
            lpGroupCli: document.getElementById('lpGroupCli').value,
            lpCug: document.getElementById('lpCug').value,

            alpId: document.getElementById('alpId').value,
            alpName: document.getElementById('alpName').value,
            alpDesg: document.getElementById('alpDesg').value,
            alpGroupCli: document.getElementById('alpGroupCli').value,
            alpCug: document.getElementById('alpCug').value,

            rakeType: document.getElementById('rakeType').value,
            mps: document.getElementById('mps').value,
            section: document.getElementById('section').value,
            
            analysisTime: new Date().toLocaleString()
        };

        try {
            const result = await processRTISData(file, inputs);
            localStorage.setItem('spmAnalysisResult', JSON.stringify(result));
            window.location.href = 'report.html';
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
    
    window.checkDuplicateEntry = async function() {
        const t = document.getElementById('trainNo').value;
        const d = document.getElementById('journeyDate').value;
        if(t && d && window.checkForDuplicateInBank) await window.checkForDuplicateInBank(t,d);
    }
</script>
</body>
</html>
