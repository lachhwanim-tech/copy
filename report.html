<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANKET Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #525659; margin: 0; padding: 20px; }
        
        /* A4 Paper Effect */
        .page-container {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative;
        }

        /* Sections */
        .section { margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .section-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; text-transform: uppercase; border-left: 5px solid #3498db; padding-left: 10px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background: #f2f2f2; font-weight: bold; }
        .red-text { color: red; font-weight: bold; }
        .green-text { color: green; font-weight: bold; }

        /* Smart Remarks Section */
        .remark-row { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 8px; border: 1px solid #ddd; margin-bottom: 5px; }
        .remark-label { font-weight: bold; flex: 2; }
        .remark-options { flex: 1; display: flex; gap: 15px; }
        .remark-input { flex: 2; display: none; } /* Hidden by default */
        .remark-input input { width: 95%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        /* Button */
        .btn-submit { background: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; width: 100%; cursor: pointer; margin-top: 20px; }
        .btn-submit:hover { background: #219150; }
        .btn-submit:disabled { background: #95a5a6; }

        @media print {
            body { background: white; padding: 0; }
            .page-container { box-shadow: none; margin: 0; width: 100%; }
            .btn-submit { display: none; }
        }
    </style>
</head>
<body>

<div class="page-container" id="reportContent">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="margin:0;">SANKET ANALYSIS REPORT</h1>
        <p style="margin:0; font-size: 14px; color: #555;">SPM Analysis & Navigation KPA Extraction Tool</p>
    </div>

    <div class="section">
        <div class="section-title">Trip Summary</div>
        <table id="tripTable">
            </table>
    </div>

    <div class="section">
        <div class="section-title">Speed Profile</div>
        <canvas id="speedChart" style="max-height: 250px;"></canvas>
    </div>

    <div class="section">
        <div class="section-title">Stop & Braking Analysis</div>
        <table id="brakingTable">
            <thead>
                <tr>
                    <th>Stop Loc</th>
                    <th>2000m</th><th>1000m</th><th>500m</th><th>100m</th><th>50m</th>
                    <th>Pattern</th>
                    <th>Remark</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div class="section">
        <div class="section-title">CLI Remarks & Abnormalities</div>
        <div id="smartRemarksContainer">
            </div>
    </div>

    <button class="btn-submit" id="btnFinalSubmit" onclick="triggerFinalSubmit()">Final Submit & Download PDF</button>

</div>

<script src="googlesheet.js"></script>
<script>
    // Load Data
    const result = JSON.parse(localStorage.getItem('spmAnalysisResult'));

    if (!result) {
        alert("No analysis data found. Redirecting to home.");
        window.location.href = 'index.html';
    }

    // --- RENDER FUNCTIONS ---

    // 1. Fill Trip Details
    const inputs = result.inputs;
    document.getElementById('tripTable').innerHTML = `
        <tr><td><strong>Train:</strong> ${inputs.trainNo}</td><td><strong>Date:</strong> ${inputs.journeyDate}</td><td><strong>Loco:</strong> ${inputs.locoNo}</td></tr>
        <tr><td><strong>CLI:</strong> ${inputs.cliName}</td><td><strong>Section:</strong> ${inputs.section}</td><td><strong>Load:</strong> ${inputs.trainLoad}</td></tr>
        <tr><td><strong>LP:</strong> ${inputs.lpName}</td><td><strong>ALP:</strong> ${inputs.alpName}</td><td><strong>Result:</strong> ${result.bftStatus} / ${result.bptStatus}</td></tr>
    `;

    // 2. Render Chart (Simplified for brevity)
    new Chart(document.getElementById('speedChart'), {
        type: 'line',
        data: {
            labels: result.stops.map(s => s.location), // Just showing stop points for now
            datasets: [{
                label: 'Approach Speed (500m)',
                data: result.stops.map(s => s.speeds[500]),
                borderColor: '#e74c3c',
                tension: 0.1
            }]
        }
    });

    // 3. Fill Braking Table
    const tbody = document.querySelector('#brakingTable tbody');
    result.stops.forEach(stop => {
        const row = `<tr>
            <td>${stop.location}</td>
            <td>${stop.speeds[2000]}</td>
            <td>${stop.speeds[1000]}</td>
            <td>${stop.speeds[500]}</td>
            <td>${stop.speeds[100]}</td>
            <td>${stop.speeds[50]}</td>
            <td class="${stop.analysis === 'Smooth Braking' ? 'green-text' : 'red-text'}">${stop.analysis}</td>
            <td>${stop.remark}</td>
        </tr>`;
        tbody.innerHTML += row;
    });

    // 4. SMART REMARKS LOGIC (The Core Request)
    const remarksContainer = document.getElementById('smartRemarksContainer');
    
    // List potential abnormalities
    const abnormalities = [];
    if (result.bftStatus === 'Not Done') abnormalities.push("BFT Not Done");
    if (result.bptStatus === 'Not Done') abnormalities.push("BPT Not Done");
    if (result.overspeedCount > 0) abnormalities.push(`Overspeeding (${result.overspeedCount} times)`);
    // Add any "Late Braking" found
    const lateStops = result.stops.filter(s => s.analysis === 'Late Braking').length;
    if (lateStops > 0) abnormalities.push(`Late Braking Detected (${lateStops} times)`);

    if (abnormalities.length === 0) {
        remarksContainer.innerHTML = "<p style='color:green; text-align:center;'>System Analysis: OK (No Abnormalities Found)</p>";
    } else {
        abnormalities.forEach((abn, index) => {
            const div = document.createElement('div');
            div.className = 'remark-row';
            div.innerHTML = `
                <div class="remark-label">${abn}</div>
                <div class="remark-options">
                    <label><input type="radio" name="abn_${index}" value="yes" checked onchange="toggleRemarkBox(${index}, 'yes')"> Agree</label>
                    <label><input type="radio" name="abn_${index}" value="no" onchange="toggleRemarkBox(${index}, 'no')"> Disagree</label>
                </div>
                <div class="remark-input" id="box_${index}">
                    <input type="text" id="text_${index}" placeholder="Reason (Max 20 words)" maxlength="150">
                </div>
            `;
            remarksContainer.appendChild(div);
        });
    }

    // Toggle Text Box
    window.toggleRemarkBox = function(index, value) {
        const box = document.getElementById(`box_${index}`);
        box.style.display = (value === 'no') ? 'block' : 'none';
        // Clear text if hidden
        if(value === 'yes') document.getElementById(`text_${index}`).value = '';
    }

    // --- SUBMISSION ---
    window.triggerFinalSubmit = function() {
        // 1. Gather Final Remarks
        let finalRemarksList = [];
        
        abnormalities.forEach((abn, index) => {
            const isAgreed = document.querySelector(`input[name="abn_${index}"]:checked`).value === 'yes';
            const manualText = document.getElementById(`text_${index}`).value;
            
            if (isAgreed) {
                finalRemarksList.push(`${abn}: Agreed`);
            } else {
                finalRemarksList.push(`${abn}: Disagreed - ${manualText}`);
            }
        });

        // 2. Update Payload
        // We append these remarks to the Record Row
        result.sheetPayload.recordRow['CLI Obs'] = finalRemarksList.join(' | ');

        // 3. Send
        submitFinalReport(result.sheetPayload, generatePDF);
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.text("SANKET Analysis Report", 105, 15, { align: "center" });
        // (Simplified PDF Generation for example - In production, use html2canvas or autoTable fully)
        doc.autoTable({ html: '#tripTable', startY: 25 });
        doc.autoTable({ html: '#brakingTable', startY: 60 });
        
        // Add Remarks
        doc.text("CLI Remarks:", 14, doc.lastAutoTable.finalY + 10);
        const remarksText = result.sheetPayload.recordRow['CLI Obs'] || "System OK";
        doc.setFontSize(10);
        doc.text(remarksText, 14, doc.lastAutoTable.finalY + 16, { maxWidth: 180 });

        doc.save(`${inputs.trainNo}_Report.pdf`);
    }
</script>

</body>
</html>
