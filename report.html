<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detailed Analysis Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #555; }
        .paper { background: white; max-width: 210mm; margin: 0 auto; padding: 10mm; min-height: 297mm; }
        h1, h2 { text-align: center; color: #000; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 4px; text-align: center; }
        th { background: #eee; }
        .btn { display: block; width: 100%; padding: 20px; font-size: 20px; background: green; color: white; cursor: pointer; margin-bottom: 20px;}
    </style>
</head>
<body>

    <button class="btn" onclick="generateLongReport()">DOWNLOAD FULL PDF REPORT (8-10 PAGES)</button>

    <div class="paper" id="previewArea">
        <h1>SANKET ANALYSIS REPORT</h1>
        <div id="loading">Loading Data...</div>
    </div>

<script>
    const data = JSON.parse(localStorage.getItem('spmAnalysisResult'));
    const inp = data.inputs;
    
    // Preview Logic (Just showing summary on screen, real magic is in PDF)
    document.getElementById('loading').innerHTML = `
        <p><strong>Train:</strong> ${inp.trainNo} | <strong>Date:</strong> ${inp.journeyDate} | <strong>CLI:</strong> ${inp.cliName}</p>
        <p><strong>Total Stops Found:</strong> ${data.stops.length}</p>
        <p><em>Click the Green Button to download the full detailed report.</em></p>
    `;

    async function generateLongReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, A4
        
        // --- PAGE 1: HEADER & SUMMARY ---
        doc.setFontSize(18);
        doc.text("SANKET - SPM ANALYSIS REPORT", 105, 15, { align: "center" });
        
        doc.setFontSize(10);
        const summaryData = [
            ["Train No", inp.trainNo, "Journey Date", inp.journeyDate],
            ["Loco No", inp.locoNo, "Section", inp.section],
            ["CLI Name", inp.cliName, "HQ", "SECR"], // Hardcoded for now
            ["LP Name", inp.lpName, "ALP Name", inp.alpName],
            ["Load", inp.trainLoad, "Rake Type", inp.rakeType],
            ["MPS", inp.mps, "Max Speed", data.summary.maxSpeed],
            ["BFT Status", data.bft.status, "BPT Status", data.bpt.status]
        ];

        doc.autoTable({
            startY: 25,
            head: [['Parameter', 'Value', 'Parameter', 'Value']],
            body: summaryData,
            theme: 'grid',
            headStyles: { fillColor: [40, 40, 40] }
        });

        // --- PAGE 1 (Cont.): BFT/BPT DETAILS ---
        doc.text("1. Brake Test Analysis", 14, doc.lastAutoTable.finalY + 10);
        
        const testData = [
            ["Test", "Status", "Start Time", "End Time", "Start Spd", "End Spd", "Drop", "Result"],
            ["BFT", data.bft.status, data.bft.startTime||"-", data.bft.endTime||"-", data.bft.startSpeed||0, data.bft.endSpeed||0, data.bft.drop||0, data.bft.status],
            ["BPT", data.bpt.status, "-", "-", "-", "-", "-", data.bpt.status]
        ];

        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 12,
            head: [['Test', 'Status', 'Start Time', 'End Time', 'Start Spd', 'End Spd', 'Drop', 'Result']],
            body: testData.slice(1), // Remove header from data array
            theme: 'grid'
        });

        // --- PAGE 2 to N: DETAILED BRAKING ANALYSIS (The 10 Page part) ---
        doc.text("2. Detailed Braking & Stop Analysis", 14, doc.lastAutoTable.finalY + 10);
        
        // Prepare HUGE Array
        const brakingRows = data.stops.map(stop => [
            stop.sNo,
            stop.loc,
            stop.time.split(' ')[1], // Just Time
            stop.speeds[2000],
            stop.speeds[1000],
            stop.speeds[500],
            stop.speeds[100],
            stop.speeds[50],
            stop.speeds[0],
            stop.result,
            stop.remark
        ]);

        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 12,
            head: [['S.No', 'Location', 'Time', '2000m', '1000m', '500m', '100m', '50m', '0m', 'Analysis', 'Rem']],
            body: brakingRows,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 50, 150] },
            // This allows the table to split across multiple pages automatically
            pageBreak: 'auto' 
        });

        // --- FINAL PAGE: ABNORMALITIES & SIGN ---
        let finalY = doc.lastAutoTable.finalY + 20;
        
        // Check if we need a new page
        if (finalY > 250) {
            doc.addPage();
            finalY = 20;
        }

        doc.setFontSize(12);
        doc.text("3. Abnormalities & Remarks", 14, finalY);
        
        // Fetch Remarks from Logic (Assuming passed in data)
        const remarks = [];
        if(data.bft.status !== "PASS") remarks.push("1. BFT Not Done / Failed");
        if(data.summary.overspeedCount > 0) remarks.push(`2. Overspeeding detected ${data.summary.overspeedCount} times.`);
        
        doc.setFontSize(10);
        doc.text(remarks.length ? remarks.join("\n") : "System Analysis: NIL Abnormalities", 14, finalY + 10);

        // Signatures
        doc.text("_________________", 20, finalY + 50);
        doc.text("Sig LP", 25, finalY + 55);
        
        doc.text("_________________", 150, finalY + 50);
        doc.text("Sig CLI", 155, finalY + 55);

        // Save
        doc.save(`${inp.trainNo}_Detailed_Report.pdf`);
    }
</script>
</body>
</html>
